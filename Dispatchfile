#!mesosphere/dispatch-starlark:v0.5-beta1
# vi:syntax=python

load("github.com/mesosphere/dispatch-catalog/starlark/stable/go@0.0.3", "ko")
load("github.com/mesosphere/dispatch-catalog/starlark/stable/pipeline@0.0.3", "gitResource", "pullRequest")

git = gitResource("helloworld-git")

simple_docker = ko(git, "takirala/helloworld", "helloworld", tag="$(context.build.name)")

task("unit-test-docker",
    inputs=[simple_docker],
    steps=[k8s.corev1.Container(
        name="unit-test-docker",
        image="takirala/helloworld:$(context.build.name)",
        workingDir="/test",
        command=["go", "test", "./..."])])

task("unit-test-simple",
    inputs=[git],
    steps=[k8s.corev1.Container(
        name="go-test",
        image="golang:1.14.0",
        workingDir="/workspace/{}".format(git),
        command=["go", "test", "./..."])])

simpleTasks = ["unit-test-simple", "unit-test-docker"]
action(tasks=simpleTasks, on=pullRequest())
action(tasks=simpleTasks, on=pullRequest(chatops=["test"]))
