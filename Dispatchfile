#!mesosphere/dispatch-cue:v0.4-beta1

resource "dispatch-git": {
  type: "git"
  param url: "$(context.git.url)"
  param revision: "master"
}

resource "storage-check": {
  param: {
    dir: "y"
    location: "s3://artifacts/storage-check"
    type: "gcs"
  },
  secret: {
    BOTO_CONFIG: {
      key: "boto"
      name: "s3-config"
    }
  },
  type: "storage"
}

task "build": {
  inputs: ["dispatch-git"]
  outputs: ["storage-check"]
  steps: [
    {
      name: "buildstep"
      image: "golang:1.13.0-buster"
      command: ["go", "test", "-v", "./...", "&&", "go", "build", "main.go", "&&", "./main"]
      env: [ { name: "GO111MODULE", value: "off" } ]
      workingDir: "/workspace/dispatch-git"
    }
  ]
}

actions: [
  {
    name: "hourly-build"
    tasks: ["build"]
    on: cron: {
        revision: "master" 
        schedule: "@hourly"
    }
  },
  {
    tasks: ["build"]
    on: pull_request: {
      branches: ["master"]
    }
  }
]
